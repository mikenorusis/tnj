name: Release

on:
  push:
    tags:
      - "v*.*.*"           # Triggers on tags like v0.1.0, v1.2.3, etc.

permissions:
  contents: write       # For creating releases and uploading assets
  id-token: write       # Required for Trusted Publishing to crates.io

jobs:
  # Step 1: Create the GitHub Release (so we have an upload_url early)
  create-release:
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: false
          prerelease: false

  # Step 2: Build binaries for all target platforms
  build-and-upload:
    needs: create-release
    strategy:
      matrix:
        include:
          - os: macos-latest  # Use latest ARM runner for lipo
            target: universal-apple-darwin  # Custom name
            name: tnj-macos-universal
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: tnj-windows-x64.exe

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain (macOS universal)
        if: matrix.target == 'universal-apple-darwin'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Install Rust toolchain (Windows)
        if: matrix.target != 'universal-apple-darwin'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo dependencies & build output
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Build x86_64 macOS binary
        if: matrix.target == 'universal-apple-darwin'
        run: cargo build --release --target x86_64-apple-darwin

      - name: Build aarch64 macOS binary
        if: matrix.target == 'universal-apple-darwin'
        run: cargo build --release --target aarch64-apple-darwin

      - name: Create universal binary with lipo
        if: matrix.target == 'universal-apple-darwin'
        run: |
          mkdir -p target/universal-apple-darwin/release
          lipo -create -output target/universal-apple-darwin/release/tnj \
            target/x86_64-apple-darwin/release/tnj \
            target/aarch64-apple-darwin/release/tnj

      - name: Build release binary (Windows)
        if: matrix.target != 'universal-apple-darwin'
        run: cargo build --release --target ${{ matrix.target }}

      - name: Prepare staged binary
        shell: bash
        run: |
          mkdir staging
          if [ "${{ matrix.target }}" = "universal-apple-darwin" ]; then
            cp "target/${{ matrix.target }}/release/tnj" "staging/${{ matrix.name }}"
          else
            cp "target/${{ matrix.target }}/release/tnj.exe" "staging/${{ matrix.name }}"
          fi

      - name: Upload binary to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: staging/${{ matrix.name }}
          asset_name: ${{ matrix.name }}
          asset_content_type: application/octet-stream

  # Step 3: Upload the install.sh helper script
  upload-install-script:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Upload install.sh
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./install.sh
          asset_name: install.sh
          asset_content_type: text/plain

  # Step 4: Publish to crates.io using Trusted Publishing (secure & no token secret)
  publish-crates-io:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Authenticate to crates.io via Trusted Publishing
        uses: rust-lang/crates-io-auth-action@v1
        id: auth

      - name: Publish crate
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}

  # Step 5: Update Homebrew tap formula
  update-homebrew-tap:
    needs: [create-release, build-and-upload]
    runs-on: ubuntu-latest
    permissions:
      contents: write   # For committing to the tap repo
    steps:
      - name: Bump Homebrew formula
        uses: mislav/bump-homebrew-formula-action@v3.6
        with:
          # Name of the formula file (without .rb)
          formula-name: tnj
          # Tap repository (user/repo format) where the formula should be updated
          homebrew-tap: mikenorusis/homebrew-tnj
        env:
          COMMITTER_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

